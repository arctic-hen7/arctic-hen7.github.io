{"post":{"title":"Versioned Docs with mdBook","author":"Me","description":"How to create performant, versioned documentation for free with mdBook and GitHub Pages.","id":"03ab02d7-f196-46d7-a1f9-d0c951245889","contents":"<p>\nIf you&rsquo;ve ever worked on an open-source library that&rsquo;s used by other people&rsquo;s code, you know how important documentation is. But deploying and organizing it can be challenging and expensive, especially with commercial solutions like GitBook.\n</p>\n\n<p>\nThe Rust project launched <a href=\"https://rust-lang.github.io/mdBook\">mdBook</a> a few years ago to solve the problem of deployment: it allows you to build an entirely self-contained &rsquo;book&rsquo; for your project in Markdown, which can then be served as a set of static files wherever you like!\n</p>\n\n<p>\nIn this post, I&rsquo;ll outline how to use mdBook to create documentation for a project, and how to set up multiple versions of that documentation, including a <code>next</code> version that can be constantly worked on. By the end, we&rsquo;ll have a fully functional documentation system that can be deployed to GitHub Pages for free!\n</p>\n\n<div id=\"outline-container-orgee48f30\" class=\"outline-2\">\n<h2 id=\"orgee48f30\">Setup</h2>\n<div class=\"outline-text-2\" id=\"text-orgee48f30\">\n<p>\nTo begin, you&rsquo;ll want to create a <code>docs</code> directory at the root of your project. This is where we&rsquo;ll put everything to do with the book. You&rsquo;ll also want to install mdBook itself, which can be done easily if you have <a href=\"https://rust-lang.org\">Rust</a> installed already, just run <code>cargo install mdbook</code>, or otherwise you can check out their installation guide <a href=\"https://rust-lang.github.io/mdBook/cli/index.html\">here</a>.\n</p>\n\n<p>\nThis tutorial will also cover automating many common tasks with documentation management using a tool called <a href=\"https://github.com/arctic-hen7/bonnie\">Bonnie</a> (full disclosure: I&rsquo;m the maintainer), which you can install with <code>cargo install bonnie</code>, or by looking through it&rsquo;s <a href=\"https://github.com/arctic-hen7/bonnie#installation\">installation guide</a>.\n</p>\n</div>\n</div>\n\n<div id=\"outline-container-org5ab1faa\" class=\"outline-2\">\n<h2 id=\"org5ab1faa\">Creating a structure</h2>\n<div class=\"outline-text-2\" id=\"text-org5ab1faa\">\n<p>\nWhat we&rsquo;re building is a <b>versioned</b> book, meaning that it will have a separate book for each version of your project. In beta, these should correspond to minor version (e.g. 0.1.x, 0.2.x, etc.), and in stable these should correspond to major versions (e.g. 1.x.x, 2.x.x, etc.).\n</p>\n\n<p>\nTo achieve this, we&rsquo;ll need a separate mdBook for each version, and an additional one called <code>next</code>, which will house the documentation for the next version, which allows you to work on documentation dynamically, without having to add it all at the end for fear of disrupting existing users.\n</p>\n\n<p>\nTo begin, we&rsquo;ll create a <code>.gitignore</code> under <code>docs/</code> and put the following inside:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"src src-gitignore\">book\ndist\n</pre>\n</div>\n\n<p>\nThis tells Git to ignore directories with the name <code>book/</code> or <code>dist/</code>, wherever under <code>docs/</code> they might occur.\n</p>\n\n<p>\nThen, create the following directories:\n</p>\n\n<ul class=\"org-ul\">\n<li><code>common</code> &#x2013; stores files common to all versions, which will be kept in sync with symlinks</li>\n<li><code>next</code> &#x2013; stores documentation for the next version to be released\n<ul class=\"org-ul\">\n<li><code>src</code></li>\n</ul></li>\n<li>A directory for each version of your project thus far (e.g. <code>0.1.x</code>, <code>1.x.x</code>, <code>2.x.x</code>, etc.)\n<ul class=\"org-ul\">\n<li><code>src</code></li>\n</ul></li>\n</ul>\n</div>\n</div>\n\n<div id=\"outline-container-orgb5dffa9\" class=\"outline-2\">\n<h2 id=\"orgb5dffa9\">Writing a book</h2>\n<div class=\"outline-text-2\" id=\"text-orgb5dffa9\">\n<p>\nNow it&rsquo;s time to create some actual documentation! In the <code>src</code> directory for each version, you can write documentation in Markdown, and you can create a sidebar in the specially named <code>src/SUMMARY.md</code> file.\n</p>\n\n<p>\nBut, before you can serve your book, you&rsquo;ll need to create a <code>book.toml</code> to define its options. However, this will be the same for every version, so we&rsquo;ll store it once in <code>common/</code> and symlink it to each version.\n</p>\n\n<p>\nCreate <code>common/book.toml</code> with the following content:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"src src-toml\">[<span class=\"org-type\">book</span>]\n<span class=\"org-variable-name\">authors</span> = [<span class=\"org-string\">\"your name here\"</span>]\n<span class=\"org-variable-name\">language</span> = <span class=\"org-string\">\"en\"</span>\n<span class=\"org-variable-name\">multilingual</span> = <span class=\"org-keyword\">false</span>\n<span class=\"org-variable-name\">src</span> = <span class=\"org-string\">\"src\"</span>\n<span class=\"org-variable-name\">title</span> = <span class=\"org-string\">\"Name of Your Book\"</span>\n\n[<span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\">rust</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>]\n<span class=\"org-variable-name\">edition</span> = <span class=\"org-string\">\"2018\"</span>\n</pre>\n</div>\n\n<p>\nThis sets some metadata (including disabling internationalization, which you can read more about in mdBook&rsquo;s <a href=\"https://rust-lang.github.io/mdBook\">documentation</a>), and also sets the version of Rust to use for your book&rsquo;s integrated playground as the 2018 version of Rust. mdBook comes with a Rust interpreter built-in, which essentially adds a play button to any snippets of Rust code you declare in your book (you can stop a snippet from being played by setting the language to <code>rust,no_playground,no_run</code> instead of just <code>rust</code>). If you&rsquo;re not using Rust, this part is irrelevant to you.\n</p>\n\n<p>\nNow we need to make sure that every version of our book has access to that common <code>book.toml</code> file, which we can do with symlinks (references to another file&rsquo;s location on Unix systems, like Linux and MacOS). Run the following command for each of your versions, as well as <code>next</code> (while in <code>docs/</code>):\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"src src-bash\"><span class=\"org-type\">ln</span> -s ../common/book.toml <span class=\"org-rainbow-delimiters-depth-1\">[</span>VERSION-HERE-OR-next<span class=\"org-rainbow-delimiters-depth-1\">]</span>/book.toml\n</pre>\n</div>\n\n<p>\nIf you&rsquo;re unfamiliar with symlinks, <b>that first argument is relative to the location of the second</b>, which allows the OS to find the file without an absolute path.\n</p>\n\n<p>\nNow that we&rsquo;ve done that, you should be able to <code>cd</code> into any of your versions and run <code>mdbook serve</code> to preview that version of your book in your browser at <a href=\"http://localhost:3000\">http://localhost:3000</a>!\n</p>\n</div>\n</div>\n\n<div id=\"outline-container-org012307e\" class=\"outline-2\">\n<h2 id=\"org012307e\">Adding warnings</h2>\n<div class=\"outline-text-2\" id=\"text-org012307e\">\n<p>\nAll this is well and good, but there will only be one version of your documentation that is stable at any one time, all others will be outdated, and <code>next</code> will be unpublished. Users may well accidentally navigate to the wrong version, and we should display warnings to make sure they know where they are!\n</p>\n\n<p>\nFortunately, mdBook makes this process very easy by allowing us to modify the internals of our book under the <code>theme/</code> directory. We&rsquo;ll start off by doing so for the <code>next</code> version.\n</p>\n\n<p>\nStart off by creating a new directory <code>theme/</code> under <code>docs/next/</code>, and create a new file called <code>header.hbs</code>. This is a Handlebars file, which is like HTML with bonuses, and it&rsquo;s what mdBook uses internally. The contents of this file will be appended to the top of every page of your book, which means it&rsquo;s the perfect place to define a warning for users that alerts them that they may be looking at the wrong version of your documentation.\n</p>\n\n<p>\nInside <code>header.hbs</code>, put the following code:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"src src-html\">&lt;<span class=\"org-function-name\">style</span>&gt;\n    header.warning {\n        background-color: rgb(242, 222, 222);\n        border-bottom-color: rgb(238, 211, 215);\n        border-bottom-left-radius: 4px;\n        border-bottom-right-radius: 4px;\n        border-bottom-style: solid;\n        border-bottom-width: 0.666667px;\n        border-image-outset: 0 0 0 0;\n        border-image-repeat: stretch stretch;\n        border-image-slice: 100% 100% 100% 100%;\n        border-image-source: none;\n        border-image-width: 1 1 1 1;\n        border-left-color: rgb(238, 211, 215);\n        border-left-style: solid;\n        border-left-width: 0.666667px;\n        border-right-color: rgb(238, 211, 215);\n        border-right-style: solid;\n        border-right-width: 0.666667px;\n        border-top-color: rgb(238, 211, 215);\n        border-top-left-radius: 4px;\n        border-top-right-radius: 4px;\n        border-top-style: solid;\n        border-top-width: 0.666667px;\n        color: rgb(185, 74, 72);\n        padding-bottom: 8px;\n        padding-left: 14px;\n        padding-right: 35px;\n        padding-top: 8px;\n        text-align: center;\n        margin-bottom: 0px;\n        margin-left: 0px;\n        margin-right: 0px;\n        margin-top: 30px;\n    }\n&lt;/<span class=\"org-function-name\">style</span>&gt;\n&lt;<span class=\"org-function-name\">header</span> <span class=\"org-variable-name\">class</span>=<span class=\"org-string\">\"warning\"</span>&gt;\n    This documentation is for the &lt;<span class=\"org-function-name\">strong</span>&gt;<span class=\"org-bold\">unpublished</span>&lt;/<span class=\"org-function-name\">strong</span>&gt; next version of Perseus,\n    and features documented here may not yet be available in the existing releases.\n    &lt;<span class=\"org-function-name\">br</span>&gt;\n    You can find documentation for the most recently released version of Perseus\n    &lt;<span class=\"org-function-name\">a</span> <span class=\"org-variable-name\">href</span>=<span class=\"org-string\">\"https://arctic-hen7.github.io/perseus/stable.html\"</span>&gt;here&lt;/<span class=\"org-function-name\">a</span>&gt;.\n&lt;/<span class=\"org-function-name\">header</span>&gt;\n</pre>\n</div>\n\n<p>\nMost of this is copied from <a href=\"https://github.com/arctic-hen7/perseus\">Perseus</a>, in which I have this documentation setup deployed.\n</p>\n\n<p>\nNow create another file called <code>common/header_old.hbs</code>, and put the same content in there, but with different text that tells the user that version is outdated. Now, we&rsquo;ll symlink that into every outdated version with these commands (run once for each old version):\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"src src-bash\"><span class=\"org-type\">ln</span> -s ../../common/index.hbs <span class=\"org-rainbow-delimiters-depth-1\">[</span>VERSION<span class=\"org-rainbow-delimiters-depth-1\">]</span>/theme/index.hbs\n<span class=\"org-type\">ln</span> -s ../../common/header_old.hbs <span class=\"org-rainbow-delimiters-depth-1\">[</span>VERSION<span class=\"org-rainbow-delimiters-depth-1\">]</span>/theme/header.hbs\n</pre>\n</div>\n\n<p>\nUnfortunately, at the time of writing, there&rsquo;s an open issue on mdBook <a href=\"https://github.com/rust-lang/mdBook/issues/1331\">here</a> whereby that warning will be half invisible, so we&rsquo;ll also need to modify the body of the book to fix that. This is a pretty easy fix, but it does involve a <b>very</b> large amount of copy-pasta. Note that this file will be the same for every version with a warning (so <code>next</code> and all the old versions), so we can create this as <code>common/index.hbs</code>. Then, put the code in <a href=\"https://gist.github.com/arctic-hen7/bff44c165fdfcbfd8b5b3b7bb6ca4587\">this</a> Gist in there (all I&rsquo;ve done is switched lines 117 and 118 so the header is below the menu bar).\n</p>\n\n<p>\nNow, we&rsquo;ll link that common file to all the versions that need a warning with this command (run once for each version):\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"src src-bash\"><span class=\"org-type\">ln</span> -s ../common/index.hbs <span class=\"org-rainbow-delimiters-depth-1\">[</span>VERSION-HERE-OR-next<span class=\"org-rainbow-delimiters-depth-1\">]</span>/theme/index.hbs\n</pre>\n</div>\n\n<p>\nNow, if you run <code>mdbook serve</code> in any of your versions with a warning, you should see it at the top of the page!\n</p>\n</div>\n</div>\n\n<div id=\"outline-container-orge6ab738\" class=\"outline-2\">\n<h2 id=\"orge6ab738\">Making the <code>stable.html</code> alias</h2>\n<div class=\"outline-text-2\" id=\"text-orge6ab738\">\n<p>\nYou&rsquo;ve probably noticed that, in the example warning I provided before, I included a link to the latest stable version of the documentation. If you have a ton of old versions, you don&rsquo;t want to be updated this constantly, hence, we can use a <code>stable.html</code> file to redirect the user to the latest stable version, and, when we push a new version, we only have to change one thing!\n</p>\n\n<p>\nThis process is very simple, just create a <code>stable.html</code> file at the root of <code>docs/</code>, and add the following:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"src src-html\"><span class=\"org-comment-delimiter\">&lt;!-- </span><span class=\"org-comment\">This file redirects the user to the latest stable version.</span><span class=\"org-comment-delimiter\"> --&gt;</span>\n&lt;<span class=\"org-keyword\">!DOCTYPE</span> html&gt;\n&lt;<span class=\"org-function-name\">html</span>&gt;\n    &lt;<span class=\"org-function-name\">head</span>&gt;\n        &lt;<span class=\"org-function-name\">meta</span>\n            <span class=\"org-variable-name\">http-equiv</span>=<span class=\"org-string\">\"refresh\"</span>\n            <span class=\"org-variable-name\">content</span>=<span class=\"org-string\">\"0; url = https://arctic-hen7.github.io/perseus/0.1.x\"</span>\n        /&gt;\n    &lt;/<span class=\"org-function-name\">head</span>&gt;\n&lt;/<span class=\"org-function-name\">html</span>&gt;\n</pre>\n</div>\n\n<p>\nThis document has no <code>&lt;body&gt;</code>, it literally just redirects the user. Of course, replace <code>https://arctic-hen7.github.io/perseus</code> with your own link. When you push a new version, you can update this by changing <code>0.1.x</code> to <code>0.2.x</code> or the like!\n</p>\n</div>\n</div>\n\n<div id=\"outline-container-org57abc7b\" class=\"outline-2\">\n<h2 id=\"org57abc7b\">Building everything</h2>\n<div class=\"outline-text-2\" id=\"text-org57abc7b\">\n<p>\nNow that we&rsquo;ve got versioning set up, it&rsquo;s time to build the book into one single directory of static files that we can serve, for example on GitHub Pages. We&rsquo;ll do this with a simple Bash script, which we&rsquo;ll put at <code>docs/build.sh</code>.\n</p>\n\n<p>\nIn that file, put the following:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"src src-bash\"><span class=\"org-comment-delimiter\">#</span><span class=\"org-comment\">!/bin/</span><span class=\"org-keyword\">bash</span>\n\n<span class=\"org-type\">mkdir</span> -p dist\n<span class=\"org-type\">rm</span> -rf ./dist/*\n\n<span class=\"org-comment-delimiter\"># </span><span class=\"org-comment\">Build ~next~</span>\n<span class=\"org-type\">cd</span> next\nmdbook build -d ../dist/\n<span class=\"org-type\">cd</span> ../\n\n<span class=\"org-comment-delimiter\"># </span><span class=\"org-comment\">Loop through all directories that aren't ~common~ or ~next~ (or ~dist~ of course)</span>\n<span class=\"org-keyword\">for</span> d<span class=\"org-keyword\"> in</span> */ ; <span class=\"org-keyword\">do</span>\n    <span class=\"org-keyword\">if</span> <span class=\"org-string\">\\[\\[</span> <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>&lt;</mo><mi>s</mi><mi>p</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mo>=</mo><mi mathvariant=\"normal\">&quot;</mi><mi>o</mi><mi>r</mi><mi>g</mi><mo>−</mo><mi>v</mi><mi>a</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>b</mi><mi>l</mi><mi>e</mi><mo>−</mo><mi>n</mi><mi>a</mi><mi>m</mi><mi>e</mi><mi mathvariant=\"normal\">&quot;</mi><mo>&gt;</mo><mi>d</mi><mo>&lt;</mo><mi mathvariant=\"normal\">/</mi><mi>s</mi><mi>p</mi><mi>a</mi><mi>n</mi><mo>&gt;</mo><mo>=</mo><mo>=</mo><mo>&lt;</mo><mi>s</mi><mi>p</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mo>=</mo><mi mathvariant=\"normal\">&quot;</mi><mi>o</mi><mi>r</mi><mi>g</mi><mo>−</mo><mi>s</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi mathvariant=\"normal\">&quot;</mi><mo>&gt;</mo><mi mathvariant=\"normal\">&quot;</mi><mi>c</mi><mi>o</mi><mi>m</mi><mi>m</mi><mi>o</mi><mi>n</mi><mi mathvariant=\"normal\">/</mi><mi mathvariant=\"normal\">&quot;</mi><mo>&lt;</mo><mi mathvariant=\"normal\">/</mi><mi>s</mi><mi>p</mi><mi>a</mi><mi>n</mi><mo>&gt;</mo><mi mathvariant=\"normal\">∣</mi><mi mathvariant=\"normal\">∣</mi></mrow><annotation encoding=\"application/x-tex\">&lt;span class=&quot;org-variable-name&quot;&gt;d&lt;/span&gt; == &lt;span class=&quot;org-string&quot;&gt;&quot;common/&quot;&lt;/span&gt; || </annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5782em;vertical-align:-0.0391em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">an</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">ss</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord\">&quot;</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">or</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7778em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">iab</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">e</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7335em;vertical-align:-0.0391em;\"></span><span class=\"mord mathnormal\">nam</span><span class=\"mord mathnormal\">e</span><span class=\"mord\">&quot;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&gt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7335em;vertical-align:-0.0391em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">/</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">an</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&gt;==&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">an</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">ss</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord\">&quot;</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">or</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">in</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mord\">&quot;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&gt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">&quot;</span><span class=\"mord mathnormal\">co</span><span class=\"mord mathnormal\">mm</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mord\">/&quot;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">/</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">an</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&gt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">∣∣</span></span></span></span><span class=\"org-variable-name\">d</span> == <span class=\"org-string\">\"next/\"</span> || $<span class=\"org-variable-name\">d</span> == <span class=\"org-string\">\"dist/\"</span> <span class=\"org-string\">\\]\\]</span>; <span class=\"org-keyword\">then</span>\n        <span class=\"org-keyword\">continue</span>\n    <span class=\"org-keyword\">else</span>\n        <span class=\"org-type\">cd</span> $<span class=\"org-variable-name\">d</span>\n        mdbook build -d ../dist/$<span class=\"org-variable-name\">d</span>\n        <span class=\"org-type\">cd</span> ../\n    <span class=\"org-keyword\">fi</span>\n<span class=\"org-keyword\">done</span>\n\n<span class=\"org-comment-delimiter\"># </span><span class=\"org-comment\">Copy in the redirection for the latest stable version</span>\n<span class=\"org-type\">cp</span> stable.html dist/stable.html\n</pre>\n</div>\n\n<p>\nHere&rsquo;s what this code does (note that it should be executed in <code>docs/</code>):\n</p>\n\n<ol class=\"org-ol\">\n<li>Make sure the <code>dist/</code> directory exists and that it&rsquo;s empty.</li>\n<li>Build the <code>next</code> version to the root of that directory. This means that users will, by default, be served with the latest version of your documentation, which avoids problems of initial redirection. This is also common practice with most OSS projects.</li>\n<li>Loop through all directories in <code>docs/</code> that aren&rsquo;t <code>next</code>, <code>common</code>, or <code>dist</code> (the directories for each version), and build them to <code>dist/[VERSION]</code>.</li>\n<li>Copy <code>stable.html</code> into the root of <code>dist/</code>.</li>\n</ol>\n\n<p>\nYou can run this script with this command (we don&rsquo;t need to make it executable):\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"src src-bash\">bash build.sh\n</pre>\n</div>\n\n<p>\nAfter that, open <code>dist/index.html</code> in your browser, and you should see the <code>next</code> version of your documentation, with a link to the latest stable version! If you go to <code>0.1.x</code> or some other old version, you should see a warning saying it&rsquo;s outdated and a link back to the latest stable version!\n</p>\n</div>\n</div>\n\n<div id=\"outline-container-org898cc68\" class=\"outline-2\">\n<h2 id=\"org898cc68\">Automating with Bonnie</h2>\n<div class=\"outline-text-2\" id=\"text-org898cc68\">\n<p>\nThis process of updating your documentation for a new version can be tedious, but it can be automated easily with a tool I built a little while ago called <a href=\"https://github.com/arctic-hen7/bonnie\">Bonnie</a>. If you haven&rsquo;t installed this yet (<code>cargo install bonnie</code> or see <a href=\"https://github.com/arctic-hen7/bonnie#installation\">the installation docs</a>), do so now.\n</p>\n\n<p>\nFirst off, a code dump for your <code>bonnie.toml</code> (this should be in the root of your project, outside <code>docs/</code>).\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"src src-toml\"><span class=\"org-variable-name\">version</span>=<span class=\"org-string\">\"0.3.2\"</span>\n\n[<span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\"><span class=\"org-type\">scripts</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>]\n<span class=\"org-variable-name\">docs.cmd</span> = [\n    <span class=\"org-string\">\"cd docs/next\"</span>,\n    <span class=\"org-string\">\"mdbook serve\"</span>\n]\n<span class=\"org-variable-name\">docs.desc</span> = <span class=\"org-string\">\"hosts the latest version of the book locally at http://localhost:3000\"</span>\n<span class=\"org-variable-name\">docs.subcommands.version.cmd</span> = [\n    <span class=\"org-string\">\"cd docs/%version\"</span>,\n    <span class=\"org-string\">\"mdbook serve\"</span>\n]\n<span class=\"org-variable-name\">docs.subcommands.version.args</span> = [ <span class=\"org-string\">\"version\"</span> ]\n<span class=\"org-variable-name\">docs.subcommands.version.desc</span> = <span class=\"org-string\">\"hosts the given version of the book locally at http://localhost:3000\"</span>\n<span class=\"org-variable-name\">docs.subcommands.deprecate.cmd</span> = [\n    <span class=\"org-string\">\"cd docs/%version\"</span>,\n    <span class=\"org-string\">\"mkdir theme\"</span>,\n    <span class=\"org-string\">\"ln -s ../../common/index.hbs theme/index.hbs\"</span>,\n    <span class=\"org-string\">\"ln -s ../../common/header_old.hbs theme/header.hbs\"</span>\n]\n<span class=\"org-variable-name\">docs.subcommands.deprecate.args</span> = [ <span class=\"org-string\">\"version\"</span> ]\n<span class=\"org-variable-name\">docs.subcommands.deprecate.desc</span> = <span class=\"org-string\">\"marks the given version of the docs as old and links to the latest\"</span>\n<span class=\"org-variable-name\">docs.subcommands.create.cmd</span> = [\n    <span class=\"org-string\">\"mkdir docs/%version\"</span>,\n    <span class=\"org-string\">\"cd docs/%version\"</span>,\n    <span class=\"org-string\">\"ln -s ../common/book.toml book.toml\"</span>,\n    <span class=\"org-string\">\"cp -r ../next/src src\"</span>,\n    <span class=\"org-string\">\"cd ../\"</span>,\n    <span class=\"org-string\">\"sed -i -E 's/perseus\\\\/(.+)\\\"/perseus\\\\/0.2.x\\\"/' stable.html\"</span>\n]\n<span class=\"org-variable-name\">docs.subcommands.create.args</span> = [ <span class=\"org-string\">\"version\"</span> ]\n<span class=\"org-variable-name\">docs.subcommands.create.desc</span> = <span class=\"org-string\">\"creates documentation for a new version from ~next~ and marks it as stable (doesn't deprecate old versions though)\"</span>\n<span class=\"org-variable-name\">docs.subcommands.build.cmd</span> = [\n    <span class=\"org-string\">\"cd docs\"</span>,\n    <span class=\"org-string\">\"bash ./build.sh\"</span>\n]\n<span class=\"org-variable-name\">docs.subcommands.build.desc</span> = <span class=\"org-string\">\"builds the book for deployment to GitHub pages or the like\"</span>\n</pre>\n</div>\n\n<p>\nFirst, this declares the version of Bonnie we&rsquo;re using (v0.3.2 at time of writing), which you can get by running <code>bonnie -v</code> in your terminal. Then, we define the following commands (you can see details by typing <code>bonnie help</code> in the root of your project):\n</p>\n\n<ul class=\"org-ul\">\n<li><code>docs</code> &#x2013; hosts the <code>next</code> version of your docs at <a href=\"http://localhost:3000\">http://localhost:3000</a></li>\n<li><code>docs version &lt;version&gt;</code> &#x2013; hosts version <code>&lt;version&gt;</code> of your docs at <a href=\"http://localhost:3000\">http://localhost:3000</a></li>\n<li><code>docs deprecate &lt;version&gt;</code> &#x2013; adds an outdated banner to <code>&lt;version&gt;</code></li>\n<li><code>docs create &lt;version&gt;</code> &#x2013; creates a new version of your docs from <code>next</code> and marks it as stable</li>\n<li><code>docs build</code> &#x2013; runs <code>docs/build.sh</code> and builds your docs to <code>docs/dist/</code></li>\n</ul>\n\n<p>\nThe only thing we need to change here is in the last line of <code>docs.subcommands.create.cmd</code>, which is a <code>sed</code> substitution that replaces the current stable version with the new one in <code>docs/stable.html</code>. Replace <code>perseus</code> in this with whatever comes directly before the version of your docs. For example, if your docs for <code>1.x.x</code> are hosted at <code>example.com/docs/1.x.x</code>, this would be <code>docs</code>. If they were directly at <code>example.com</code>, this would be <code>com</code>. You can use <a href=\"https://regex101.com\">this tool</a> to make sure that substitution works.\n</p>\n\n<p>\nAfter you&rsquo;ve done that, you can now control your documentation with ease!\n</p>\n</div>\n</div>\n\n<div id=\"outline-container-org38bc224\" class=\"outline-2\">\n<h2 id=\"org38bc224\">GitHub Pages and Actions</h2>\n<div class=\"outline-text-2\" id=\"text-org38bc224\">\n<p>\nNow it&rsquo;s time to deploy your book to the internet! We&rsquo;ll do this on <a href=\"https://pages.github.com\">GitHub Pages</a>, a free service operated by GitHub that lets you create a website associated with your user account (mine is <a href=\"https://arctic-hen7.github.io\">https://arctic-hen7.github.io</a>, which is what you&rsquo;re looking at right now!).\n</p>\n\n<p>\nWe can use another service called <a href=\"https://actions.github.com\">GitHub Actions</a> to automatically build your book and deploy it whenever you push to your repository, which is free for public repositories, and paid for private (with a small free tier). I&rsquo;ll assume here that you&rsquo;ve already set up a Pages site for your account, but if not, there&rsquo;s a great tutorial <a href=\"https://github.com/features/actions\">here</a> by GitHub themselves.\n</p>\n\n<p>\nNow, to create a GitHub Actions workflow, create a new file at the root of your repository/project called <code>.github/workflows/book.yml</code> and put the following inside:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"src src-yaml\"><span class=\"org-variable-name\">name</span>: Compile and Deploy Book\n\n<span class=\"org-variable-name\">on</span>:\n    <span class=\"org-variable-name\">push</span>:\n        <span class=\"org-variable-name\">paths</span>:\n            - <span class=\"org-string\">\"docs/**\"</span>\n            - <span class=\"org-string\">\".github/workflows/book.yml\"</span> <span class=\"org-comment-delimiter\"># </span><span class=\"org-comment\">If we change this build script, it should rerun</span>\n\n<span class=\"org-variable-name\">jobs</span>:\n    <span class=\"org-variable-name\">deploy</span>:\n        <span class=\"org-variable-name\">runs-on</span>: ubuntu-latest\n        <span class=\"org-variable-name\">steps</span>:\n            - <span class=\"org-variable-name\">uses</span>: actions/checkout@v2\n            - <span class=\"org-variable-name\">name</span>: Setup mdBook\n              <span class=\"org-variable-name\">uses</span>: peaceiris/actions-mdbook@v1\n              <span class=\"org-variable-name\">with</span>:\n                  <span class=\"org-variable-name\">mdbook-version</span>: <span class=\"org-string\">\"latest\"</span>\n            - <span class=\"org-variable-name\">name</span>: Build book\n              <span class=\"org-variable-name\">run</span>: bash build.sh\n              <span class=\"org-variable-name\">working-directory</span>: docs\n            - <span class=\"org-variable-name\">name</span>: Deploy book to GitHub Pages\n              <span class=\"org-variable-name\">uses</span>: peaceiris/actions-gh-pages@v3\n              <span class=\"org-variable-name\">if</span>: github.ref == <span class=\"org-string\">'refs/heads/main'</span>\n              <span class=\"org-variable-name\">with</span>:\n                  <span class=\"org-variable-name\">github_token</span>: ${{ secrets.GITHUB_TOKEN }}\n                  <span class=\"org-variable-name\">publish_dir</span>: docs/dist\n</pre>\n</div>\n\n<p>\nThis creates a new workflow called <code>Compile and Deploy Book</code> that runs whenever you push to GitHub and there&rsquo;s a change to either the <code>docs/</code> folder or this script itself. Then, it runs a single job called <code>deploy</code>, which will run on Ubuntu (in the cloud). Here&rsquo;s what that does:\n</p>\n\n<ol class=\"org-ol\">\n<li>Installs mdBook using <a href=\"https://github.com/peaceiris/actions-mdbook\">this action</a>.</li>\n<li>Builds your book using <code>docs/build.sh</code>.</li>\n<li>Deploys the <code>docs/dist</code> to a new <code>gh-pages</code> branch on your repository with <a href=\"https://github.com/peaceiris/actions-gh-pages\">this action</a>.</li>\n</ol>\n\n<p>\nNow try pushing to your repository on Github as usual (<code>git push origin main</code> or something similar), and go to the <code>Actions</code> tab of your repository on GitHub. You should see a new job running, which should complete pretty quickly (installing mdBook will be the longest-running part), and then you&rsquo;ll be able to see a new <code>gh-pages</code> branch in the <code>Code</code> tab! Now, this won&rsquo;t have deployed to Pages just yet, we&rsquo;ll need to configure that under the <code>Settings</code> tab. Go there, and then go to <code>Pages</code> in the sidebar, and set the branch to <code>gh-pages</code> and press <b>Save</b>! You should see a green message at the top of that page when you reload that has a URL to your newly deployed book!\n</p>\n</div>\n</div>\n\n<div id=\"outline-container-org4a9bc9a\" class=\"outline-2\">\n<h2 id=\"org4a9bc9a\">Closing Words</h2>\n<div class=\"outline-text-2\" id=\"text-org4a9bc9a\">\n<p>\nIn this tutorial, we&rsquo;ve built a fully versioned and automated documentation system for your project, which can be deployed for free to the wider internet!\n</p>\n\n<p>\nIf you&rsquo;re stuck on any part of this, you can see the entire setup in my <a href=\"https://github.com/arctic-hen7/perseus\">Perseus</a> project (under the <code>v0.2.x</code> tag), which uses this setup verbatim.\n</p>\n</div>\n</div>","tags":["dev","tutorial","open-source-admin"],"series":null,"toc":"<div id=\"table-of-contents\" role=\"doc-toc\">\n\n<div id=\"text-table-of-contents\" role=\"doc-toc\">\n<ul>\n<li><a href=\"post/03ab02d7-f196-46d7-a1f9-d0c951245889#orgee48f30\">Setup</a></li>\n<li><a href=\"post/03ab02d7-f196-46d7-a1f9-d0c951245889#org5ab1faa\">Creating a structure</a></li>\n<li><a href=\"post/03ab02d7-f196-46d7-a1f9-d0c951245889#orgb5dffa9\">Writing a book</a></li>\n<li><a href=\"post/03ab02d7-f196-46d7-a1f9-d0c951245889#org012307e\">Adding warnings</a></li>\n<li><a href=\"post/03ab02d7-f196-46d7-a1f9-d0c951245889#orge6ab738\">Making the <code>stable.html</code> alias</a></li>\n<li><a href=\"post/03ab02d7-f196-46d7-a1f9-d0c951245889#org57abc7b\">Building everything</a></li>\n<li><a href=\"post/03ab02d7-f196-46d7-a1f9-d0c951245889#org898cc68\">Automating with Bonnie</a></li>\n<li><a href=\"post/03ab02d7-f196-46d7-a1f9-d0c951245889#org38bc224\">GitHub Pages and Actions</a></li>\n<li><a href=\"post/03ab02d7-f196-46d7-a1f9-d0c951245889#org4a9bc9a\">Closing Words</a></li>\n</ul>\n</div>\n</div>","date":"2021-09-15"},"source":".","mtime":{"secs_since_epoch":1671943463,"nanos_since_epoch":613394996}}
